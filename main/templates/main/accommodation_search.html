{% extends 'main/base.html' %}
{% load custom_filters %}

{% block title %}宿泊施設検索 - {% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-bed text-primary"></i> 宿泊施設検索</h2>
            <p class="text-muted">ご希望の条件で宿泊施設を検索できます。</p>
        </div>
    </div>

    <!-- 検索フォーム -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="fas fa-search"></i> 検索条件</h5>
                </div>
                <div class="card-body">
                    <form method="GET" action="{% url 'accommodation_search' %}">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="checkin_date" class="form-label">チェックイン日 <span class="text-danger">*</span></label>
                                <input type="date" name="checkin_date" id="checkin_date" class="form-control" 
                                       value="{{ request.GET.checkin_date }}" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="checkout_date" class="form-label">チェックアウト日 <span class="text-danger">*</span></label>
                                <input type="date" name="checkout_date" id="checkout_date" class="form-control" 
                                       value="{{ request.GET.checkout_date }}" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="guests" class="form-label">宿泊人数</label>
                                <select name="guests" id="guests" class="form-select">
                                    <option value="1" {% if request.GET.guests == "1" %}selected{% endif %}>1名</option>
                                    <option value="2" {% if request.GET.guests == "2" %}selected{% endif %}>2名</option>
                                    <option value="3" {% if request.GET.guests == "3" %}selected{% endif %}>3名</option>
                                    <option value="4" {% if request.GET.guests == "4" %}selected{% endif %}>4名</option>
                                    <option value="5" {% if request.GET.guests == "5" %}selected{% endif %}>5名以上</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="location" class="form-label">場所</label>
                                <select name="location" id="location" class="form-select">
                                    <option value="">すべての場所</option>
                                    {% for loc in locations %}
                                        <option value="{{ loc }}" {% if request.GET.location == loc %}selected{% endif %}>{{ loc }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="rank" class="form-label">ランク</label>
                                <select name="rank" id="rank" class="form-select">
                                    <option value="">すべてのランク</option>
                                    <option value="1" {% if request.GET.rank == "1" %}selected{% endif %}>★</option>
                                    <option value="2" {% if request.GET.rank == "2" %}selected{% endif %}>★★</option>
                                    <option value="3" {% if request.GET.rank == "3" %}selected{% endif %}>★★★</option>
                                    <option value="4" {% if request.GET.rank == "4" %}selected{% endif %}>★★★★</option>
                                    <option value="5" {% if request.GET.rank == "5" %}selected{% endif %}>★★★★★</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="min_price" class="form-label">最低価格</label>
                                <input type="number" name="min_price" id="min_price" class="form-control" 
                                       placeholder="円" value="{{ request.GET.min_price }}">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="max_price" class="form-label">最高価格</label>
                                <input type="number" name="max_price" id="max_price" class="form-control" 
                                       placeholder="円" value="{{ request.GET.max_price }}">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">設備・サービス</label>
                                <div class="d-flex flex-wrap gap-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="amenities" value="WiFi" id="wifi"
                                               {% if "WiFi" in selected_amenities %}checked{% endif %}>
                                        <label class="form-check-label" for="wifi">WiFi</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="amenities" value="プール" id="pool"
                                               {% if "プール" in selected_amenities %}checked{% endif %}>
                                        <label class="form-check-label" for="pool">プール</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="amenities" value="スパ" id="spa"
                                               {% if "スパ" in selected_amenities %}checked{% endif %}>
                                        <label class="form-check-label" for="spa">スパ</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="amenities" value="ジム" id="gym"
                                               {% if "ジム" in selected_amenities %}checked{% endif %}>
                                        <label class="form-check-label" for="gym">ジム</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="amenities" value="朝食付き" id="breakfast"
                                               {% if "朝食付き" in selected_amenities %}checked{% endif %}>
                                        <label class="form-check-label" for="breakfast">朝食付き</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i> 検索
                                </button>
                                <a href="{% url 'accommodation_search' %}" class="btn btn-outline-secondary ms-2">
                                    <i class="fas fa-times"></i> クリア
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 検索結果 -->
    {% if date_required_message %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-warning text-center">
                <i class="fas fa-calendar-alt"></i>
                {{ date_required_message }}
            </div>
        </div>
    </div>
    {% elif date_error_message %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-danger text-center">
                <i class="fas fa-exclamation-triangle"></i>
                {{ date_error_message }}
            </div>
        </div>
    </div>
    {% elif accommodations %}
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h4>検索結果</h4>
                    {% if total_results %}
                        <p class="text-muted mb-0">
                            全{{ total_results }}件中 
                            {{ accommodations.start_index }}〜{{ accommodations.end_index }}件を表示
                            {% if is_paginated %}
                                ({{ accommodations.number }}/{{ accommodations.paginator.num_pages }}ページ)
                            {% endif %}
                        </p>
                    {% endif %}
                </div>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary active" onclick="toggleView('card')">
                        <i class="fas fa-th-large"></i> カード表示
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="toggleView('list')">
                        <i class="fas fa-list"></i> リスト表示
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- カード表示 -->
    <div id="card-view" class="row">
        {% for accommodation in accommodations %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 accommodation-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="card-title">{{ accommodation.name }}</h5>
                        <div class="text-end">
                            <div class="text-warning">
                                {% for i in "12345"|make_list %}
                                    {% if forloop.counter <= accommodation.rank %}
                                        <i class="fas fa-star"></i>
                                    {% else %}
                                        <i class="far fa-star"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <p class="text-muted mb-2">
                        <i class="fas fa-map-marker-alt"></i> {{ accommodation.location }}
                    </p>
                    <p class="card-text">{{ accommodation.description|truncatewords:15 }}</p>
                    
                    {% if accommodation.amenities %}
                    <div class="mb-3">
                        <small class="text-muted">設備・サービス:</small><br>
                        {% for amenity in accommodation.amenities %}
                            <span class="badge bg-light text-dark me-1">{{ amenity }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="h5 text-primary">¥{{ accommodation.price_per_night|floatformat:0 }}</span>
                            <small class="text-muted">/泊</small>
                            {% if accommodation.available_for_dates %}
                                <br><span class="badge bg-success mt-1">空室あり</span>
                            {% else %}
                                <br><span class="badge bg-danger mt-1">空室なし</span>
                            {% endif %}
                        </div>
                        <div>
                            <div class="btn-group">
                                <button class="btn btn-primary btn-sm" 
                                        onclick="addAccommodationToCart({{ accommodation.id }})"
                                        {% if not accommodation.available_for_dates %}disabled{% endif %}
                                        title="カートに追加">
                                    <i class="fas fa-cart-plus"></i> カートに追加
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- リスト表示 -->
    <div id="list-view" class="d-none">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>宿泊施設名</th>
                        <th>場所</th>
                        <th>ランク</th>
                        <th>価格/泊</th>
                        <th>設備・サービス</th>
                        <th>アクション</th>
                    </tr>
                </thead>
                <tbody>
                    {% for accommodation in accommodations %}
                    <tr>
                        <td>
                            <strong>{{ accommodation.name }}</strong><br>
                            <small class="text-muted">{{ accommodation.description|truncatewords:10 }}</small>
                        </td>
                        <td>{{ accommodation.location }}</td>
                        <td>
                            <div class="text-warning">
                                {% for i in "12345"|make_list %}
                                    {% if forloop.counter <= accommodation.rank %}
                                        <i class="fas fa-star"></i>
                                    {% else %}
                                        <i class="far fa-star"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </td>
                        <td>
                            <span class="text-primary fw-bold">¥{{ accommodation.price_per_night|floatformat:0 }}</span>
                            {% if accommodation.available_for_dates %}
                                <br><span class="badge bg-success">空室あり</span>
                            {% else %}
                                <br><span class="badge bg-danger">空室なし</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if accommodation.amenities %}
                                {% for amenity in accommodation.amenities|slice:":3" %}
                                    <span class="badge bg-light text-dark me-1">{{ amenity }}</span>
                                {% endfor %}
                                {% if accommodation.amenities|length > 3 %}
                                    <span class="text-muted">...</span>
                                {% endif %}
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-primary btn-sm" 
                                        onclick="addAccommodationToCart({{ accommodation.id }})"
                                        {% if not accommodation.available_for_dates %}disabled{% endif %}
                                        title="カートに追加">
                                    <i class="fas fa-cart-plus"></i> カートに追加
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% else %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info text-center">
                <i class="fas fa-info-circle"></i>
                {% if total_results == 0 and not date_required_message and not date_error_message %}
                    条件に合う宿泊施設が見つかりませんでした。検索条件を変更してお試しください。
                {% else %}
                    検索条件を指定して宿泊施設を検索してください。
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ページネーション -->
    {% if is_paginated %}
    <div class="row mt-4">
        <div class="col-12">
            <nav aria-label="ページナビゲーション">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1" aria-label="最初のページ">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}" aria-label="前のページ">
                                <i class="fas fa-angle-left"></i> 前へ
                            </a>
                        </li>
                    {% endif %}
                    
                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <li class="page-item active" aria-current="page">
                                <span class="page-link">{{ num }}</span>
                            </li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
                            </li>
                        {% elif num == 1 or num == page_obj.paginator.num_pages %}
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
                            </li>
                        {% elif num == page_obj.number|add:'-4' or num == page_obj.number|add:'4' %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}" aria-label="次のページ">
                                次へ <i class="fas fa-angle-right"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.paginator.num_pages }}" aria-label="最後のページ">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            
            <!-- ページ情報表示 -->
            <div class="text-center mt-2">
                <small class="text-muted">
                    ページ {{ page_obj.number }} / {{ page_obj.paginator.num_pages }} 
                    (全{{ total_results }}件の結果)
                </small>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- 航空券おすすめモーダル -->
<div class="modal fade" id="flightRecommendationModal" tabindex="-1" aria-labelledby="flightRecommendationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="flightRecommendationModalLabel">
                    <i class="fas fa-plane"></i> 航空券のご提案
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong id="accommodation-destination"></strong>での宿泊が決まりました！<br>
                    次に、航空券はいかがですか？お得な便をご提案いたします。
                </div>
                
                <!-- 航空券検索エリア -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-search"></i> 航空券を検索</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="modal-departure" class="form-label">出発地</label>
                                <select class="form-select" id="modal-departure">
                                    <option value="">選択してください</option>
                                    <option value="東京">東京</option>
                                    <option value="大阪">大阪</option>
                                    <option value="名古屋">名古屋</option>
                                    <option value="福岡">福岡</option>
                                    <option value="札幌">札幌</option>
                                    <option value="沖縄">沖縄</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="modal-destination" class="form-label">目的地</label>
                                <input type="text" class="form-control" id="modal-destination" readonly>
                            </div>
                            <div class="col-md-3">
                                <label for="modal-departure-date" class="form-label">出発日</label>
                                <input type="date" class="form-control" id="modal-departure-date" readonly>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button class="btn btn-primary w-100" onclick="searchRecommendedFlights()">
                                    <i class="fas fa-search"></i> 検索
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 検索結果エリア -->
                <div id="flight-search-results" class="d-none">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-plane-departure"></i> おすすめ航空券</h6>
                        </div>
                        <div class="card-body">
                            <div id="flight-results-container">
                                <!-- 航空券検索結果がここに表示される -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ローディング状態 -->
                <div id="flight-search-loading" class="d-none text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">検索中...</span>
                    </div>
                    <p class="mt-2">航空券を検索しています...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> 航空券は後で検索
                </button>
                <a href="{% url 'cart' %}" class="btn btn-success">
                    <i class="fas fa-shopping-cart"></i> カートを確認
                </a>
                <a href="{% url 'flight_search' %}" class="btn btn-primary">
                    <i class="fas fa-external-link-alt"></i> 航空券検索ページへ
                </a>
            </div>
        </div>
    </div>
</div>

<script>
function toggleView(viewType) {
    const cardView = document.getElementById('card-view');
    const listView = document.getElementById('list-view');
    const buttons = document.querySelectorAll('.btn-group button');
    
    buttons.forEach(btn => btn.classList.remove('active'));
    
    if (viewType === 'card') {
        cardView.classList.remove('d-none');
        listView.classList.add('d-none');
        buttons[0].classList.add('active');
    } else {
        cardView.classList.add('d-none');
        listView.classList.remove('d-none');
        buttons[1].classList.add('active');
    }
}

// ページ読み込み時に選択状態を確認
document.addEventListener('DOMContentLoaded', function() {
    // 日付フィールドの最小値を今日に設定
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('checkin_date').min = today;
    document.getElementById('checkout_date').min = today;
    
    // チェックイン日が変更された時の処理
    document.getElementById('checkin_date').addEventListener('change', function() {
        const checkinDate = this.value;
        if (checkinDate) {
            // チェックアウト日の最小値をチェックイン日の翌日に設定
            const checkinDateObj = new Date(checkinDate);
            checkinDateObj.setDate(checkinDateObj.getDate() + 1);
            const minCheckoutDate = checkinDateObj.toISOString().split('T')[0];
            document.getElementById('checkout_date').min = minCheckoutDate;
            
            // チェックアウト日がチェックイン日より前の場合はリセット
            const checkoutDate = document.getElementById('checkout_date').value;
            if (checkoutDate && checkoutDate <= checkinDate) {
                document.getElementById('checkout_date').value = minCheckoutDate;
            }
        }
    });
    
    const selected = sessionStorage.getItem('selectedAccommodation');
    if (selected) {
        const data = JSON.parse(selected);
        // 選択状態を視覚的に表示する場合はここに追加
    }
});

// カートに宿泊施設を追加
function addAccommodationToCart(accommodationId) {
    const checkinDate = document.getElementById('checkin_date').value;
    const checkoutDate = document.getElementById('checkout_date').value;
    
    if (!checkinDate || !checkoutDate) {
        alert('チェックイン日とチェックアウト日を選択してください。');
        return;
    }
    
    fetch('{% url "add_accommodation_to_cart" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            accommodation_id: accommodationId,
            checkin_date: checkinDate,
            checkout_date: checkoutDate
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 成功メッセージを表示
            showToast(data.message, 'success');
            
            // 航空券おすすめモーダルを表示
            showFlightRecommendationModal(data.accommodation, checkinDate, checkoutDate);
        } else {
            showToast(data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('カートへの追加中にエラーが発生しました', 'danger');
    });
}

// 航空券おすすめモーダルを表示
function showFlightRecommendationModal(accommodation, checkinDate, checkoutDate) {
    // 宿泊施設の場所を目的地として設定
    document.getElementById('accommodation-destination').textContent = accommodation.location;
    document.getElementById('modal-destination').value = accommodation.location;
    document.getElementById('modal-departure-date').value = checkinDate;
    
    // 目的地に応じた出発地の推奨設定
    const destinationToRecommendedDeparture = {
        '東京': '大阪',
        '大阪': '東京', 
        '沖縄': '東京',
        '北海道': '東京',
        '札幌': '東京',
        '福岡': '東京',
        '京都': '東京',
        '名古屋': '東京'
    };
    
    const recommendedDeparture = destinationToRecommendedDeparture[accommodation.location] || '東京';
    const departureSelect = document.getElementById('modal-departure');
    
    // 推奨出発地を選択
    for (let option of departureSelect.options) {
        if (option.value === recommendedDeparture) {
            option.selected = true;
            break;
        }
    }
    
    // 検索結果をリセット
    document.getElementById('flight-search-results').classList.add('d-none');
    document.getElementById('flight-search-loading').classList.add('d-none');
    
    // モーダルを表示
    const modal = new bootstrap.Modal(document.getElementById('flightRecommendationModal'));
    modal.show();
    
    // モーダル表示後に自動検索を実行
    setTimeout(() => {
        if (recommendedDeparture) {
            searchRecommendedFlights();
        }
    }, 500);
}

// おすすめ航空券を検索
function searchRecommendedFlights() {
    const departure = document.getElementById('modal-departure').value;
    const destination = document.getElementById('modal-destination').value;
    const departureDate = document.getElementById('modal-departure-date').value;
    
    if (!departure) {
        alert('出発地を選択してください。');
        return;
    }
    
    // ローディング表示
    document.getElementById('flight-search-loading').classList.remove('d-none');
    document.getElementById('flight-search-results').classList.add('d-none');
    
    // 航空券検索API呼び出し
    fetch('{% url "flight_search" %}?' + new URLSearchParams({
        departure: departure,
        destination: destination,
        departure_date: departureDate,
        modal: 'true'
    }))
    .then(response => response.text())
    .then(html => {
        // ローディング非表示
        document.getElementById('flight-search-loading').classList.add('d-none');
        
        // HTMLからフライトリストを抽出
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const flightList = doc.querySelector('#flight-list');
        
        if (flightList && flightList.children.length > 0) {
            // 結果を表示
            let flightHtml = flightList.innerHTML;
            
            // モーダル内での航空券追加機能のために、JavaScriptを調整
            flightHtml = flightHtml.replace(/onclick="addToCart\(/g, 'onclick="addFlightToCartFromModal(');
            
            document.getElementById('flight-results-container').innerHTML = flightHtml;
            document.getElementById('flight-search-results').classList.remove('d-none');
        } else {
            // 結果なしの場合
            document.getElementById('flight-results-container').innerHTML = `
                <div class="alert alert-warning text-center">
                    <i class="fas fa-plane"></i>
                    条件に合う航空券が見つかりませんでした。<br>
                    <small>出発地を変更するか、航空券検索ページで詳細な検索をお試しください。</small>
                </div>
            `;
            document.getElementById('flight-search-results').classList.remove('d-none');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('flight-search-loading').classList.add('d-none');
        document.getElementById('flight-results-container').innerHTML = `
            <div class="alert alert-danger text-center">
                <i class="fas fa-exclamation-triangle"></i>
                航空券検索中にエラーが発生しました。しばらく後にお試しください。
            </div>
        `;
        document.getElementById('flight-search-results').classList.remove('d-none');
    });
}

// モーダル内で航空券をカートに追加
function addFlightToCartFromModal(flightId, direction = 'oneway') {
    fetch('{% url "add_flight_to_cart" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            flight_id: flightId,
            direction: direction
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            
            // モーダルを閉じる
            const modal = bootstrap.Modal.getInstance(document.getElementById('flightRecommendationModal'));
            modal.hide();
            
            // カートページへのリンクを表示するか選択肢を提示
            setTimeout(() => {
                if (confirm('航空券をカートに追加しました。カートを確認しますか？')) {
                    window.location.href = '{% url "cart" %}';
                }
            }, 500);
        } else {
            showToast(data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('カートへの追加中にエラーが発生しました', 'danger');
    });
}
</script>
{% endblock %}
