{% extends 'main/base.html' %}
{% load custom_filters %}

{% block title %}宿泊施設検索 - {% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-bed text-primary"></i> 宿泊施設検索</h2>
            <p class="text-muted">ご希望の条件で宿泊施設を検索できます。</p>
        </div>
    </div>

    <!-- 検索フォーム -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="fas fa-search"></i> 検索条件</h5>
                </div>
                <div class="card-body">
                    <form method="GET" action="{% url 'accommodation_search' %}">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="checkin_date" class="form-label">チェックイン日 <span class="text-danger">*</span></label>
                                <input type="date" name="checkin_date" id="checkin_date" class="form-control" 
                                       value="{{ request.GET.checkin_date }}" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="checkout_date" class="form-label">チェックアウト日 <span class="text-danger">*</span></label>
                                <input type="date" name="checkout_date" id="checkout_date" class="form-control" 
                                       value="{{ request.GET.checkout_date }}" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="guests" class="form-label">宿泊人数</label>
                                <select name="guests" id="guests" class="form-select">
                                    <option value="1" {% if request.GET.guests == "1" %}selected{% endif %}>1名</option>
                                    <option value="2" {% if request.GET.guests == "2" %}selected{% endif %}>2名</option>
                                    <option value="3" {% if request.GET.guests == "3" %}selected{% endif %}>3名</option>
                                    <option value="4" {% if request.GET.guests == "4" %}selected{% endif %}>4名</option>
                                    <option value="5" {% if request.GET.guests == "5" %}selected{% endif %}>5名以上</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="location" class="form-label">場所</label>
                                <select name="location" id="location" class="form-select">
                                    <option value="">すべての場所</option>
                                    {% for loc in locations %}
                                        <option value="{{ loc }}" {% if request.GET.location == loc %}selected{% endif %}>{{ loc }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="rank" class="form-label">ランク</label>
                                <select name="rank" id="rank" class="form-select">
                                    <option value="">すべてのランク</option>
                                    <option value="1" {% if request.GET.rank == "1" %}selected{% endif %}>★</option>
                                    <option value="2" {% if request.GET.rank == "2" %}selected{% endif %}>★★</option>
                                    <option value="3" {% if request.GET.rank == "3" %}selected{% endif %}>★★★</option>
                                    <option value="4" {% if request.GET.rank == "4" %}selected{% endif %}>★★★★</option>
                                    <option value="5" {% if request.GET.rank == "5" %}selected{% endif %}>★★★★★</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="min_price" class="form-label">最低価格</label>
                                <input type="number" name="min_price" id="min_price" class="form-control" 
                                       placeholder="円" value="{{ request.GET.min_price }}">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="max_price" class="form-label">最高価格</label>
                                <input type="number" name="max_price" id="max_price" class="form-control" 
                                       placeholder="円" value="{{ request.GET.max_price }}">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">設備・サービス</label>
                                <div class="d-flex flex-wrap gap-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="amenities" value="WiFi" id="wifi"
                                               {% if "WiFi" in selected_amenities %}checked{% endif %}>
                                        <label class="form-check-label" for="wifi">WiFi</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="amenities" value="プール" id="pool"
                                               {% if "プール" in selected_amenities %}checked{% endif %}>
                                        <label class="form-check-label" for="pool">プール</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="amenities" value="スパ" id="spa"
                                               {% if "スパ" in selected_amenities %}checked{% endif %}>
                                        <label class="form-check-label" for="spa">スパ</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="amenities" value="ジム" id="gym"
                                               {% if "ジム" in selected_amenities %}checked{% endif %}>
                                        <label class="form-check-label" for="gym">ジム</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="amenities" value="朝食付き" id="breakfast"
                                               {% if "朝食付き" in selected_amenities %}checked{% endif %}>
                                        <label class="form-check-label" for="breakfast">朝食付き</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i> 検索
                                </button>
                                <a href="{% url 'accommodation_search' %}" class="btn btn-outline-secondary ms-2">
                                    <i class="fas fa-times"></i> クリア
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 検索結果 -->
    {% if date_required_message %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-warning text-center">
                <i class="fas fa-calendar-alt"></i>
                {{ date_required_message }}
            </div>
        </div>
    </div>
    {% elif date_error_message %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-danger text-center">
                <i class="fas fa-exclamation-triangle"></i>
                {{ date_error_message }}
            </div>
        </div>
    </div>
    {% elif accommodations %}
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>検索結果 ({{ accommodations|length }}件)</h4>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary active" onclick="toggleView('card')">
                        <i class="fas fa-th-large"></i> カード表示
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="toggleView('list')">
                        <i class="fas fa-list"></i> リスト表示
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- カード表示 -->
    <div id="card-view" class="row">
        {% for accommodation in accommodations %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 accommodation-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="card-title">{{ accommodation.name }}</h5>
                        <div class="text-end">
                            <div class="text-warning">
                                {% for i in "12345"|make_list %}
                                    {% if forloop.counter <= accommodation.rank %}
                                        <i class="fas fa-star"></i>
                                    {% else %}
                                        <i class="far fa-star"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <p class="text-muted mb-2">
                        <i class="fas fa-map-marker-alt"></i> {{ accommodation.location }}
                    </p>
                    <p class="card-text">{{ accommodation.description|truncatewords:15 }}</p>
                    
                    {% if accommodation.amenities %}
                    <div class="mb-3">
                        <small class="text-muted">設備・サービス:</small><br>
                        {% for amenity in accommodation.amenities %}
                            <span class="badge bg-light text-dark me-1">{{ amenity }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="h5 text-primary">¥{{ accommodation.price_per_night|floatformat:0 }}</span>
                            <small class="text-muted">/泊</small>
                            {% if accommodation.available_for_dates %}
                                <br><span class="badge bg-success mt-1">空室あり</span>
                            {% else %}
                                <br><span class="badge bg-danger mt-1">空室なし</span>
                            {% endif %}
                        </div>
                        <button class="btn btn-primary btn-sm" 
                                onclick="selectAccommodation({{ accommodation.id }}, '{{ accommodation.name }}', {{ accommodation.price_per_night }}, '{{ request.GET.checkin_date }}', '{{ request.GET.checkout_date }}', '{{ request.GET.guests }}')"
                                {% if not accommodation.available_for_dates %}disabled{% endif %}>
                            <i class="fas fa-check"></i> 選択
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- リスト表示 -->
    <div id="list-view" class="d-none">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>宿泊施設名</th>
                        <th>場所</th>
                        <th>ランク</th>
                        <th>価格/泊</th>
                        <th>設備・サービス</th>
                        <th>アクション</th>
                    </tr>
                </thead>
                <tbody>
                    {% for accommodation in accommodations %}
                    <tr>
                        <td>
                            <strong>{{ accommodation.name }}</strong><br>
                            <small class="text-muted">{{ accommodation.description|truncatewords:10 }}</small>
                        </td>
                        <td>{{ accommodation.location }}</td>
                        <td>
                            <div class="text-warning">
                                {% for i in "12345"|make_list %}
                                    {% if forloop.counter <= accommodation.rank %}
                                        <i class="fas fa-star"></i>
                                    {% else %}
                                        <i class="far fa-star"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </td>
                        <td>
                            <span class="text-primary fw-bold">¥{{ accommodation.price_per_night|floatformat:0 }}</span>
                            {% if accommodation.available_for_dates %}
                                <br><span class="badge bg-success">空室あり</span>
                            {% else %}
                                <br><span class="badge bg-danger">空室なし</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if accommodation.amenities %}
                                {% for amenity in accommodation.amenities|slice:":3" %}
                                    <span class="badge bg-light text-dark me-1">{{ amenity }}</span>
                                {% endfor %}
                                {% if accommodation.amenities|length > 3 %}
                                    <span class="text-muted">...</span>
                                {% endif %}
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-primary btn-sm" 
                                    onclick="selectAccommodation({{ accommodation.id }}, '{{ accommodation.name }}', {{ accommodation.price_per_night }}, '{{ request.GET.checkin_date }}', '{{ request.GET.checkout_date }}', '{{ request.GET.guests }}')"
                                    {% if not accommodation.available_for_dates %}disabled{% endif %}>
                                <i class="fas fa-check"></i> 選択
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% else %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info text-center">
                <i class="fas fa-info-circle"></i>
                条件に合う宿泊施設が見つかりませんでした。検索条件を変更してお試しください。
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ページネーション -->
    {% if is_paginated %}
    <div class="row mt-4">
        <div class="col-12">
            <nav aria-label="ページナビゲーション">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">前へ</a>
                        </li>
                    {% endif %}
                    
                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                        {% else %}
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">次へ</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
    {% endif %}
</div>

<!-- 選択モーダル -->
<div class="modal fade" id="selectionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">宿泊施設を選択しました</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="selection-info"></p>
                <p>次に航空券を選択しますか？</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">とりあえず閉じる</button>
                <a href="{% url 'flight_search' %}" class="btn btn-primary">航空券を選択</a>
            </div>
        </div>
    </div>
</div>

<script>
function toggleView(viewType) {
    const cardView = document.getElementById('card-view');
    const listView = document.getElementById('list-view');
    const buttons = document.querySelectorAll('.btn-group button');
    
    buttons.forEach(btn => btn.classList.remove('active'));
    
    if (viewType === 'card') {
        cardView.classList.remove('d-none');
        listView.classList.add('d-none');
        buttons[0].classList.add('active');
    } else {
        cardView.classList.add('d-none');
        listView.classList.remove('d-none');
        buttons[1].classList.add('active');
    }
}

function selectAccommodation(id, name, price, checkinDate, checkoutDate, guests) {
    // セッションストレージに保存
    sessionStorage.setItem('selectedAccommodation', JSON.stringify({
        id: id,
        name: name,
        price: price,
        checkin_date: checkinDate,
        checkout_date: checkoutDate,
        guests: guests
    }));
    
    // モーダルに情報を設定
    const nights = checkinDate && checkoutDate ? 
        Math.ceil((new Date(checkoutDate) - new Date(checkinDate)) / (1000 * 60 * 60 * 24)) : 1;
    const totalPrice = price * nights;
    
    document.getElementById('selection-info').innerHTML = 
        `<strong>${name}</strong><br>
         チェックイン: ${checkinDate || '未設定'}<br>
         チェックアウト: ${checkoutDate || '未設定'}<br>
         宿泊人数: ${guests || '1'}名<br>
         料金: ¥${price.toLocaleString()}/泊 × ${nights}泊 = ¥${totalPrice.toLocaleString()}`;
    
    // モーダルを表示
    const modal = new bootstrap.Modal(document.getElementById('selectionModal'));
    modal.show();
}

// ページ読み込み時に選択状態を確認
document.addEventListener('DOMContentLoaded', function() {
    // 日付フィールドの最小値を今日に設定
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('checkin_date').min = today;
    document.getElementById('checkout_date').min = today;
    
    // チェックイン日が変更された時の処理
    document.getElementById('checkin_date').addEventListener('change', function() {
        const checkinDate = this.value;
        if (checkinDate) {
            // チェックアウト日の最小値をチェックイン日の翌日に設定
            const checkinDateObj = new Date(checkinDate);
            checkinDateObj.setDate(checkinDateObj.getDate() + 1);
            const minCheckoutDate = checkinDateObj.toISOString().split('T')[0];
            document.getElementById('checkout_date').min = minCheckoutDate;
            
            // チェックアウト日がチェックイン日より前の場合はリセット
            const checkoutDate = document.getElementById('checkout_date').value;
            if (checkoutDate && checkoutDate <= checkinDate) {
                document.getElementById('checkout_date').value = minCheckoutDate;
            }
        }
    });
    
    const selected = sessionStorage.getItem('selectedAccommodation');
    if (selected) {
        const data = JSON.parse(selected);
        // 選択状態を視覚的に表示する場合はここに追加
    }
});
</script>
{% endblock %}
