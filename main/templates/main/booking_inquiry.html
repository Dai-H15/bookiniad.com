{% extends 'main/base.html' %}

{% block title %}予約照会 - BookINIAD.com{% endblock %}

{% block extra_css %}
<style>
    .booking-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
    }
    .booking-card {
        border: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border-radius: 15px;
        overflow: hidden;
    }
    .section-header {
        background-color: #f8f9fa;
        border-left: 4px solid #667eea;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    .info-row {
        padding: 0.5rem 0;
        border-bottom: 1px solid #eee;
    }
    .info-row:last-child {
        border-bottom: none;
    }
    .price-highlight {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 1rem;
        border-radius: 10px;
        text-align: center;
    }
    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 25px;
        font-weight: bold;
    }
    .status-confirmed {
        background-color: #d4edda;
        color: #155724;
    }
    .inquiry-form {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}

    <!-- ヘッダー -->
    <div class="booking-header">
        <div class="container text-center">
            <h1 class="display-4 fw-bold mb-3">
                <i class="fas fa-search me-3"></i>予約照会
            </h1>
            <p class="lead">予約番号を入力して、ご予約の詳細を確認できます</p>
        </div>
    </div>

    <div class="container my-5">
        {% if not booking %}
        <!-- 予約照会フォーム -->
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="inquiry-form">
                    <h3 class="text-center mb-4">
                        <i class="fas fa-ticket-alt text-primary me-2"></i>予約番号を入力
                    </h3>
                    
                    {% if error_message %}
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>{{ error_message }}
                    </div>
                    {% endif %}
                    
                    <form method="post">
                        {% csrf_token %}
                        <div class="mb-4">
                            <label for="reservation_number" class="form-label fw-bold">予約番号</label>
                            <input type="text" 
                                   class="form-control form-control-lg" 
                                   id="reservation_number" 
                                   name="reservation_number"
                                   placeholder="例: abc12345-def6-7890-ghij-klmnopqrstuv"
                                   required>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                予約完了時にお送りしたメールに記載されている予約番号を入力してください
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-lg w-100">
                            <i class="fas fa-search me-2"></i>予約を照会
                        </button>
                    </form>
                </div>
            </div>
        </div>
        {% else %}
        <!-- 予約詳細表示 -->
        <div class="row">
            <div class="col-12">
                <div class="booking-card">
                    <!-- 予約基本情報 -->
                    <div class="card-header bg-primary text-white">
                        <div class="row align-items-center">
                            <div class="col">
                                <h4 class="mb-0">
                                    <i class="fas fa-bookmark me-2"></i>予約詳細
                                </h4>
                                <small>予約番号: {{ booking.reservation_number }}</small>
                            </div>
                            <div class="col-auto">
                                <span class="status-badge status-confirmed">
                                    <i class="fas fa-check-circle me-1"></i>予約確定
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-body p-4">
                        <div class="row">
                            <!-- 宿泊情報 -->
                            {% if booking.accommodations %}
                            <div class="col-md-6 mb-4">
                                <div class="section-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-bed text-primary me-2"></i>宿泊施設
                                    </h5>
                                </div>
                                
                                <div class="info-row">
                                    <div class="row">
                                        <div class="col-4 text-muted">施設名</div>
                                        <div class="col-8 fw-bold">{{ booking.accommodations.name }}</div>
                                    </div>
                                </div>
                                <div class="info-row">
                                    <div class="row">
                                        <div class="col-4 text-muted">所在地</div>
                                        <div class="col-8">{{ booking.accommodations.location }}</div>
                                    </div>
                                </div>
                                <div class="info-row">
                                    <div class="row">
                                        <div class="col-4 text-muted">チェックイン</div>
                                        <div class="col-8">
                                            {% if booking_details.checkin_date %}
                                                {{ booking_details.checkin_date|date:"Y年n月j日 (D)" }}
                                            {% else %}
                                                {{ booking.from_date|date:"Y年n月j日 (D)" }}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="info-row">
                                    <div class="row">
                                        <div class="col-4 text-muted">チェックアウト</div>
                                        <div class="col-8">
                                            {% if booking_details.checkout_date %}
                                                {{ booking_details.checkout_date|date:"Y年n月j日 (D)" }}
                                            {% else %}
                                                {{ booking.to_date|date:"Y年n月j日 (D)" }}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="info-row">
                                    <div class="row">
                                        <div class="col-4 text-muted">宿泊日数</div>
                                        <div class="col-8">{{ booking_details.nights }}泊</div>
                                    </div>
                                </div>
                                <div class="info-row">
                                    <div class="row">
                                        <div class="col-4 text-muted">宿泊人数</div>
                                        <div class="col-8">{{ booking.num_of_people }}名</div>
                                    </div>
                                </div>
                                
                                {% if booking_details.days_until_checkin > 0 %}
                                <div class="mt-3 p-2 bg-info bg-opacity-10 rounded">
                                    <small class="text-info">
                                        <i class="fas fa-calendar-day me-1"></i>
                                        チェックインまで{{ booking_details.days_until_checkin }}日
                                    </small>
                                </div>
                                {% elif booking_details.days_until_checkin == 0 %}
                                <div class="mt-3 p-2 bg-success bg-opacity-10 rounded">
                                    <small class="text-success">
                                        <i class="fas fa-calendar-check me-1"></i>
                                        本日チェックインです
                                    </small>
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                            
                            <!-- 航空券情報 -->
                            {% if booking_details.flights %}
                            <div class="col-md-6 mb-4">
                                <div class="section-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-plane text-primary me-2"></i>航空券
                                    </h5>
                                </div>
                                
                                {% for flight in booking_details.flights %}
                                <div class="mb-3 p-3 border rounded">
                                    <div class="info-row">
                                        <div class="row">
                                            <div class="col-4 text-muted">航空会社</div>
                                            <div class="col-8 fw-bold">{{ flight.name }}</div>
                                        </div>
                                    </div>
                                    <div class="info-row">
                                        <div class="row">
                                            <div class="col-4 text-muted">出発地</div>
                                            <div class="col-8">{{ flight.place_from }}</div>
                                        </div>
                                    </div>
                                    <div class="info-row">
                                        <div class="row">
                                            <div class="col-4 text-muted">到着地</div>
                                            <div class="col-8">{{ flight.place_to }}</div>
                                        </div>
                                    </div>
                                    <div class="info-row">
                                        <div class="row">
                                            <div class="col-4 text-muted">出発日時</div>
                                            <div class="col-8">{{ flight.departure_time|date:"Y年n月j日 H:i" }}</div>
                                        </div>
                                    </div>
                                    <div class="info-row">
                                        <div class="row">
                                            <div class="col-4 text-muted">到着日時</div>
                                            <div class="col-8">{{ flight.arrival_time|date:"Y年n月j日 H:i" }}</div>
                                        </div>
                                    </div>
                                    <div class="info-row">
                                        <div class="row">
                                            <div class="col-4 text-muted">搭乗者数</div>
                                            <div class="col-8">{{ booking.num_of_people }}名</div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- 料金詳細 -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="section-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-yen-sign text-primary me-2"></i>料金詳細
                                    </h5>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-8">
                                        {% if booking.accommodations %}
                                        <div class="info-row">
                                            <div class="row">
                                                <div class="col-8">
                                                    宿泊料金 ({{ booking_details.nights }}泊 × {{ booking.num_of_people }}名)
                                                    <small class="text-muted d-block">
                                                        ¥{{ booking.accommodations.price_per_night|floatformat:0 }}/泊 × {{ booking_details.nights }}泊 × {{ booking.num_of_people }}名
                                                    </small>
                                                </div>
                                                <div class="col-4 text-end">¥{{ booking_details.accommodation_total|floatformat:0 }}</div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        {% if booking_details.flights %}
                                        <div class="info-row">
                                            <div class="row">
                                                <div class="col-8">
                                                    航空券代金 ({{ booking.num_of_people }}名分)
                                                    <small class="text-muted d-block">
                                                        {% for flight in booking_details.flights %}
                                                            ¥{{ flight.fee|floatformat:0 }}/名 × {{ booking.num_of_people }}名{% if not forloop.last %} + {% endif %}
                                                        {% endfor %}
                                                    </small>
                                                </div>
                                                <div class="col-4 text-end">¥{{ booking_details.flight_total|floatformat:0 }}</div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        {% if booking_details.calculated_total != booking.total_fee %}
                                        <div class="info-row">
                                            <div class="row">
                                                <div class="col-8">
                                                    <small class="text-muted">
                                                        <i class="fas fa-exclamation-triangle text-warning"></i>
                                                        元の保存金額 (参考)
                                                    </small>
                                                </div>
                                                <div class="col-4 text-end">
                                                    <small class="text-muted">¥{{ booking.total_fee|floatformat:0 }}</small>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="price-highlight">
                                            <h4 class="mb-1">総合計</h4>
                                            <h2 class="mb-0">¥{{ booking_details.calculated_total|floatformat:0 }}</h2>
                                            {% if booking_details.calculated_total != booking.total_fee %}
                                            <small class="opacity-75">
                                                <i class="fas fa-info-circle me-1"></i>
                                                人数反映後の金額です
                                            </small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- アクションボタン -->
                        <div class="row mt-4">
                            <div class="col-12 text-center">
                                <button onclick="window.print()" class="btn btn-outline-primary me-2">
                                    <i class="fas fa-print me-2"></i>印刷
                                </button>
                                <a href="{% url 'booking_inquiry' %}" class="btn btn-secondary me-2">
                                    <i class="fas fa-search me-2"></i>別の予約を照会
                                </a>
                                <a href="{% url 'index' %}" class="btn btn-primary">
                                    <i class="fas fa-home me-2"></i>ホームに戻る
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
{% endblock %}
