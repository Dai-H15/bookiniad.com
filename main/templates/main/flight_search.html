{% extends 'main/base.html' %}

{% block title %}航空券検索 - {% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-plane text-primary"></i> 航空券検索</h2>
            <p class="text-muted">ご希望の条件で航空券を検索できます。</p>
        </div>
    </div>

    <!-- 検索フォーム -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="fas fa-search"></i> 検索条件</h5>
                </div>
                <div class="card-body">
                    <form method="GET" action="{% url 'flight_search' %}">
                        <div class="row">
                            <div class="col-md-2 mb-3">
                                <label for="departure_date" class="form-label">出発日</label>
                                <input type="date" name="departure_date" id="departure_date" class="form-control" 
                                       value="{{ request.GET.departure_date }}" placeholder="未定でも検索可能">
                                <small class="text-muted">未指定でも検索できます</small>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label for="return_date" class="form-label">復路日（任意）</label>
                                <input type="date" name="return_date" id="return_date" class="form-control" 
                                       value="{{ request.GET.return_date }}" placeholder="片道の場合は未入力">
                                <small class="text-muted">往復の場合のみ</small>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label for="passengers" class="form-label">人数</label>
                                <select name="passengers" id="passengers" class="form-select">
                                    <option value="1" {% if request.GET.passengers == "1" %}selected{% endif %}>1名</option>
                                    <option value="2" {% if request.GET.passengers == "2" %}selected{% endif %}>2名</option>
                                    <option value="3" {% if request.GET.passengers == "3" %}selected{% endif %}>3名</option>
                                    <option value="4" {% if request.GET.passengers == "4" %}selected{% endif %}>4名</option>
                                    <option value="5" {% if request.GET.passengers == "5" %}selected{% endif %}>5名以上</option>
                                </select>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label for="departure" class="form-label">出発地</label>
                                <select name="departure" id="departure" class="form-select">
                                    <option value="">すべての出発地</option>
                                    {% for dept in departures %}
                                        <option value="{{ dept }}" {% if request.GET.departure == dept %}selected{% endif %}>{{ dept }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label for="destination" class="form-label">目的地</label>
                                <select name="destination" id="destination" class="form-select">
                                    <option value="">すべての目的地</option>
                                    {% for dest in destinations %}
                                        <option value="{{ dest }}" {% if request.GET.destination == dest %}selected{% endif %}>{{ dest }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label for="flight_type" class="form-label">便の種類</label>
                                <select name="flight_type" id="flight_type" class="form-select">
                                    <option value="">すべての便</option>
                                    <option value="domestic" {% if request.GET.flight_type == "domestic" %}selected{% endif %}>国内線</option>
                                    <option value="international" {% if request.GET.flight_type == "international" %}selected{% endif %}>国際線</option>
                                </select>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label for="airline" class="form-label">航空会社</label>
                                <select name="airline" id="airline" class="form-select">
                                    <option value="">すべての航空会社</option>
                                    {% for al in airlines %}
                                        <option value="{{ al }}" {% if request.GET.airline == al %}selected{% endif %}>{{ al }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="min_price" class="form-label">最低価格</label>
                                <input type="number" name="min_price" id="min_price" class="form-control" 
                                       placeholder="円" value="{{ request.GET.min_price }}">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="max_price" class="form-label">最高価格</label>
                                <input type="number" name="max_price" id="max_price" class="form-control" 
                                       placeholder="円" value="{{ request.GET.max_price }}">
                            </div>
                            <div class="col-md-6 mb-3 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="fas fa-search"></i> 検索
                                </button>
                                <a href="{% url 'flight_search' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times"></i> クリア
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 検索結果 -->
    {% if date_error_message %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-danger text-center">
                <i class="fas fa-exclamation-triangle"></i>
                {{ date_error_message }}
            </div>
        </div>
    </div>
    {% elif flights or return_flights %}
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h4>検索結果</h4>
                    {% if is_round_trip %}
                        <p class="text-muted mb-0">
                            往路: {{ outbound_count }}件、復路: {{ return_count }}件
                        </p>
                    {% else %}
                        <p class="text-muted mb-0">
                            全{{ total_results }}件中 
                            {{ flights.start_index }}〜{{ flights.end_index }}件を表示
                            {% if is_paginated %}
                                ({{ flights.number }}/{{ flights.paginator.num_pages }}ページ)
                            {% endif %}
                        </p>
                    {% endif %}
                </div>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary active" onclick="toggleView('card')">
                        <i class="fas fa-th-large"></i> カード表示
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="toggleView('list')">
                        <i class="fas fa-list"></i> リスト表示
                    </button>
                </div>
            </div>
        </div>
    </div>

    {% if is_round_trip %}
    <!-- 往復検索の場合のタブ表示 -->
    <div class="row mb-3">
        <div class="col-12">
            <ul class="nav nav-tabs" id="flightTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="outbound-tab" data-bs-toggle="tab" data-bs-target="#outbound" type="button" role="tab">
                        <i class="fas fa-plane-departure"></i> 往路 ({{ outbound_count }}件)
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="return-tab" data-bs-toggle="tab" data-bs-target="#return" type="button" role="tab">
                        <i class="fas fa-plane-arrival"></i> 復路 ({{ return_count }}件)
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <div class="tab-content" id="flightTabContent">
        <!-- 往路タブ -->
        <div class="tab-pane fade show active" id="outbound" role="tabpanel">
            {% include 'main/flight_list_partial.html' with flight_list=flights flight_direction='outbound' %}
        </div>
        
        <!-- 復路タブ -->
        <div class="tab-pane fade" id="return" role="tabpanel">
            {% include 'main/flight_list_partial.html' with flight_list=return_flights flight_direction='return' %}
        </div>
    </div>
    {% else %}
    <!-- 片道検索の場合は直接表示 -->

    <!-- 片道検索の場合は直接表示 -->
    {% include 'main/flight_list_partial.html' with flight_list=flights flight_direction='outbound' %}
    {% endif %}

    {% else %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info text-center">
                <i class="fas fa-info-circle"></i>
                {% if total_results == 0 and not date_error_message %}
                    条件に合う航空券が見つかりませんでした。検索条件を変更してお試しください。
                {% else %}
                    検索条件を指定して航空券を検索してください。
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ページネーション -->
    {% if is_paginated %}
    <div class="row mt-4">
        <div class="col-12">
            <nav aria-label="ページナビゲーション">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1" aria-label="最初のページ">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}" aria-label="前のページ">
                                <i class="fas fa-angle-left"></i> 前へ
                            </a>
                        </li>
                    {% endif %}
                    
                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <li class="page-item active" aria-current="page">
                                <span class="page-link">{{ num }}</span>
                            </li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
                            </li>
                        {% elif num == 1 or num == page_obj.paginator.num_pages %}
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
                            </li>
                        {% elif num == page_obj.number|add:'-4' or num == page_obj.number|add:'4' %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}" aria-label="次のページ">
                                次へ <i class="fas fa-angle-right"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.paginator.num_pages }}" aria-label="最後のページ">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            
            <!-- ページ情報表示 -->
            <div class="text-center mt-2">
                <small class="text-muted">
                    ページ {{ page_obj.number }} / {{ page_obj.paginator.num_pages }} 
                    (全{{ total_results }}件の結果)
                </small>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
function toggleView(viewType) {
    const cardView = document.getElementById('flight-list');
    const listView = document.getElementById('list-view');
    const buttons = document.querySelectorAll('.btn-group button');
    
    buttons.forEach(btn => btn.classList.remove('active'));
    
    if (viewType === 'card') {
        cardView.classList.remove('d-none');
        listView.classList.add('d-none');
        buttons[0].classList.add('active');
    } else {
        cardView.classList.add('d-none');
        listView.classList.remove('d-none');
        buttons[1].classList.add('active');
    }
}

// カートに航空券を追加
function addToCart(flightId, direction) {
    fetch('{% url "add_flight_to_cart" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            flight_id: flightId,
            direction: direction
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 成功メッセージを表示
            showToast(data.message, 'success');
        } else {
            showToast(data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('カートへの追加中にエラーが発生しました', 'danger');
    });
}

// ページ読み込み時の初期化
document.addEventListener('DOMContentLoaded', function() {
    // 日付フィールドに今日以降の日付制限を設定
    const today = new Date().toISOString().split('T')[0];
    const departureDateField = document.getElementById('departure_date');
    const returnDateField = document.getElementById('return_date');
    
    if (departureDateField) {
        departureDateField.setAttribute('min', today);
        
        // 出発日が変更されたら復路日の最小日付を更新
        departureDateField.addEventListener('change', function() {
            if (returnDateField && this.value) {
                returnDateField.setAttribute('min', this.value);
                // 復路日が出発日より前の場合はクリア
                if (returnDateField.value && returnDateField.value < this.value) {
                    returnDateField.value = '';
                }
            }
        });
    }
    
    if (returnDateField) {
        returnDateField.setAttribute('min', today);
    }
});
</script>
{% endblock %}
