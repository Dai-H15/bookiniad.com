{% extends 'main/base.html' %}

{% block title %}パフォーマンス分析 - bookiniad.com{% endblock %}

{% block extra_css %}
<style>
    .metric-card {
        border: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    .metric-card:hover {
        transform: translateY(-2px);
    }
    .chart-container {
        position: relative;
        height: 300px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="text-center mb-5">
        <h1><i class="fas fa-chart-line"></i> パフォーマンス分析</h1>
        <p class="lead">3つのAIシステムの性能を比較分析します</p>
    </div>

    <!-- 概要メトリクス -->
    <div class="row mb-5">
        <!-- AIエージェント -->
        {% if performance_data.ai_agent %}
        <div class="col-md-4 mb-4">
            <div class="card metric-card h-100">
                <div class="card-header text-center bg-primary text-white">
                    <h5 class="mb-0">{{ performance_data.ai_agent.system_name }}</h5>
                </div>
                <div class="card-body text-center">
                    <div class="row">
                        <div class="col-6">
                            <h3 class="text-primary">{{ performance_data.ai_agent.avg_response_time }}s</h3>
                            <small class="text-muted">平均応答時間</small>
                        </div>
                        <div class="col-6">
                            <h3 class="text-success">{{ performance_data.ai_agent.total_sessions }}</h3>
                            <small class="text-muted">総セッション数</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- AIアシスタント -->
        {% if performance_data.ai_assistant %}
        <div class="col-md-4 mb-4">
            <div class="card metric-card h-100">
                <div class="card-header text-center bg-info text-white">
                    <h5 class="mb-0">{{ performance_data.ai_assistant.system_name }}</h5>
                </div>
                <div class="card-body text-center">
                    <div class="row">
                        <div class="col-6">
                            <h3 class="text-primary">{{ performance_data.ai_assistant.avg_response_time }}s</h3>
                            <small class="text-muted">平均応答時間</small>
                        </div>
                        <div class="col-6">
                            <h3 class="text-success">{{ performance_data.ai_assistant.total_sessions }}</h3>
                            <small class="text-muted">総セッション数</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- ルールベースBot -->
        {% if performance_data.rule_bot %}
        <div class="col-md-4 mb-4">
            <div class="card metric-card h-100">
                <div class="card-header text-center bg-warning">
                    <h5 class="mb-0">{{ performance_data.rule_bot.system_name }}</h5>
                </div>
                <div class="card-body text-center">
                    <div class="row">
                        <div class="col-6">
                            <h3 class="text-primary">{{ performance_data.rule_bot.avg_response_time }}s</h3>
                            <small class="text-muted">平均応答時間</small>
                        </div>
                        <div class="col-6">
                            <h3 class="text-success">{{ performance_data.rule_bot.total_sessions }}</h3>
                            <small class="text-muted">総セッション数</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        {% if not performance_data.ai_agent and not performance_data.ai_assistant and not performance_data.rule_bot %}
        <div class="col-12">
            <div class="alert alert-info text-center">
                <h4>データがありません</h4>
                <p>まずはAIシステムとの会話を体験して、パフォーマンスデータを蓄積してください。</p>
                <div class="mt-3">
                    <a href="{% url 'chat_interface' 'ai_agent' %}" class="btn btn-primary me-2">AIエージェント</a>
                    <a href="{% url 'chat_interface' 'ai_assistant' %}" class="btn btn-info me-2">AIアシスタント</a>
                    <a href="{% url 'chat_interface' 'rule_bot' %}" class="btn btn-warning">ルールBot</a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    {% if performance_data.ai_agent or performance_data.ai_assistant or performance_data.rule_bot %}
    <!-- 詳細比較 -->
    <div class="row">
        <!-- 応答時間比較 -->
        <div class="col-md-6 mb-4">
            <div class="card performance-chart">
                <div class="card-header">
                    <h5><i class="fas fa-clock"></i> 応答時間比較</h5>
                </div>
                <div class="card-body">
                    <canvas id="responseTimeChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- システム利用状況 -->
        <div class="col-md-6 mb-4">
            <div class="card performance-chart">
                <div class="card-header">
                    <h5><i class="fas fa-users"></i> システム利用状況</h5>
                </div>
                <div class="card-body">
                    <canvas id="usageChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 特徴比較表 -->
    <div class="card">
        <div class="card-header">
            <h5><i class="fas fa-table"></i> 詳細比較</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th>指標</th>
                            <th class="text-center">AIエージェント</th>
                            <th class="text-center">AIアシスタント</th>
                            <th class="text-center">ルールベースBot</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>平均応答時間</strong></td>
                            <td class="text-center">
                                {% if performance_data.ai_agent %}
                                    {{ performance_data.ai_agent.avg_response_time }}秒
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if performance_data.ai_assistant %}
                                    {{ performance_data.ai_assistant.avg_response_time }}秒
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if performance_data.rule_bot %}
                                    {{ performance_data.rule_bot.avg_response_time }}秒
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>複雑度対応</strong></td>
                            <td class="text-center"><span class="badge bg-success">高</span></td>
                            <td class="text-center"><span class="badge bg-warning">中</span></td>
                            <td class="text-center"><span class="badge bg-danger">低</span></td>
                        </tr>
                        <tr>
                            <td><strong>学習能力</strong></td>
                            <td class="text-center"><i class="fas fa-check text-success"></i></td>
                            <td class="text-center"><i class="fas fa-check text-warning"></i></td>
                            <td class="text-center"><i class="fas fa-times text-danger"></i></td>
                        </tr>
                        <tr>
                            <td><strong>運用コスト</strong></td>
                            <td class="text-center"><span class="badge bg-danger">高</span></td>
                            <td class="text-center"><span class="badge bg-warning">中</span></td>
                            <td class="text-center"><span class="badge bg-success">低</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 実験の提案 -->
    <div class="card mt-4">
        <div class="card-header bg-light">
            <h5><i class="fas fa-flask"></i> 比較実験の提案</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <h6>シンプルな質問</h6>
                    <p class="text-muted small">「東京から大阪の航空券を探して」のような明確な要求でテストしてみましょう。</p>
                    <div class="d-grid">
                        <a href="{% url 'chat_interface' 'rule_bot' %}" class="btn btn-outline-warning btn-sm">推奨: ルールBot</a>
                    </div>
                </div>
                <div class="col-md-4">
                    <h6>複雑な条件</h6>
                    <p class="text-muted small">「家族旅行で、子供が楽しめて、予算内で...」のような複雑な要求でテストしてみましょう。</p>
                    <div class="d-grid">
                        <a href="{% url 'chat_interface' 'ai_agent' %}" class="btn btn-outline-primary btn-sm">推奨: AIエージェント</a>
                    </div>
                </div>
                <div class="col-md-4">
                    <h6>データ検索</h6>
                    <p class="text-muted small">「最安値のプランは？」のような情報検索タスクでテストしてみましょう。</p>
                    <div class="d-grid">
                        <a href="{% url 'chat_interface' 'ai_assistant' %}" class="btn btn-outline-info btn-sm">推奨: AIアシスタント</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if performance_data.ai_agent or performance_data.ai_assistant or performance_data.rule_bot %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// 応答時間比較チャート
const responseTimeData = {
    labels: ['AIエージェント', 'AIアシスタント', 'ルールベースBot'],
    datasets: [{
        label: '平均応答時間 (秒)',
        data: [
            {% if performance_data.ai_agent %}{{ performance_data.ai_agent.avg_response_time }}{% else %}0{% endif %},
            {% if performance_data.ai_assistant %}{{ performance_data.ai_assistant.avg_response_time }}{% else %}0{% endif %},
            {% if performance_data.rule_bot %}{{ performance_data.rule_bot.avg_response_time }}{% else %}0{% endif %}
        ],
        backgroundColor: [
            'rgba(54, 162, 235, 0.8)',
            'rgba(23, 162, 184, 0.8)', 
            'rgba(255, 193, 7, 0.8)'
        ],
        borderColor: [
            'rgba(54, 162, 235, 1)',
            'rgba(23, 162, 184, 1)',
            'rgba(255, 193, 7, 1)'
        ],
        borderWidth: 1
    }]
};

const responseTimeCtx = document.getElementById('responseTimeChart').getContext('2d');
new Chart(responseTimeCtx, {
    type: 'bar',
    data: responseTimeData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: '応答時間 (秒)'
                }
            }
        }
    }
});

// 利用状況チャート
const usageData = {
    labels: ['AIエージェント', 'AIアシスタント', 'ルールベースBot'],
    datasets: [{
        data: [
            {% if performance_data.ai_agent %}{{ performance_data.ai_agent.total_sessions }}{% else %}0{% endif %},
            {% if performance_data.ai_assistant %}{{ performance_data.ai_assistant.total_sessions }}{% else %}0{% endif %},
            {% if performance_data.rule_bot %}{{ performance_data.rule_bot.total_sessions }}{% else %}0{% endif %}
        ],
        backgroundColor: [
            'rgba(54, 162, 235, 0.8)',
            'rgba(23, 162, 184, 0.8)',
            'rgba(255, 193, 7, 0.8)'
        ],
        borderColor: [
            'rgba(54, 162, 235, 1)',
            'rgba(23, 162, 184, 1)', 
            'rgba(255, 193, 7, 1)'
        ],
        borderWidth: 1
    }]
};

const usageCtx = document.getElementById('usageChart').getContext('2d');
new Chart(usageCtx, {
    type: 'doughnut',
    data: usageData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
</script>
{% endif %}
{% endblock %}
